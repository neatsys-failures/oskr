\hypertarget{classoskr_1_1ClientTable}{}\doxysection{Client\+Table$<$ Transport, Reply\+Message $>$}
\label{classoskr_1_1ClientTable}\index{ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}}
\doxysubsection*{Public Types}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{classoskr_1_1ClientTable_a3658e065165588e8f29ab650cd8ab71f}\label{classoskr_1_1ClientTable_a3658e065165588e8f29ab650cd8ab71f}} 
using {\bfseries Apply} = std\+::function$<$ void(std\+::function$<$ void(const typename Transport\+::\+Address \&remote, const \mbox{\hyperlink{structoskr_1_1ReplyMessage}{Reply\+Message}} \&)$>$)$>$
\end{DoxyCompactItemize}
\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
Apply \mbox{\hyperlink{classoskr_1_1ClientTable_a1108fd6ec869fef1510d9d79ad3ac9fb}{check}} (const typename Transport\+::\+Address \&remote, Client\+Id client\+\_\+id, Request\+Number request\+\_\+number)
\item 
void \mbox{\hyperlink{classoskr_1_1ClientTable_a11e9f734d654734e63b88a967ff2476a}{update}} (Client\+Id client\+\_\+id, Request\+Number request\+\_\+number)
\item 
Apply \mbox{\hyperlink{classoskr_1_1ClientTable_afe1870397cb26938df93b0244f627954}{update}} (Client\+Id client\+\_\+id, Request\+Number request\+\_\+number, \mbox{\hyperlink{structoskr_1_1ReplyMessage}{Reply\+Message}} reply)
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\subsubsection*{template$<$typename Transport, typename Reply\+Message$>$\newline
class oskr\+::\+Client\+Table$<$ Transport, Reply\+Message $>$}



Definition at line 9 of file Client\+Table.\+hpp.



\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classoskr_1_1ClientTable_a1108fd6ec869fef1510d9d79ad3ac9fb}\label{classoskr_1_1ClientTable_a1108fd6ec869fef1510d9d79ad3ac9fb}} 
\index{ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}!check@{check}}
\index{check@{check}!ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}}
\doxysubsubsection{\texorpdfstring{check()}{check()}}
{\footnotesize\ttfamily auto check (\begin{DoxyParamCaption}\item[{const typename Transport\+::\+Address \&}]{remote,  }\item[{Client\+Id}]{client\+\_\+id,  }\item[{Request\+Number}]{request\+\_\+number }\end{DoxyParamCaption})}

On handling direct request from client.

If returned {\ttfamily Apply} is truthy, the request processing should be omit\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordflow}{if} (\textcolor{keyword}{auto} apply =}
\DoxyCodeLine{        client\_table.check(remote, client\_id, request\_number)) \{}
\DoxyCodeLine{    apply([\&](\textcolor{keyword}{auto} \&remote, \textcolor{keyword}{auto} \&reply) \{}
\DoxyCodeLine{        \textcolor{comment}{// send reply to remote}}
\DoxyCodeLine{    \});}
\DoxyCodeLine{    \textcolor{keywordflow}{return};}
\DoxyCodeLine{\}}
\DoxyCodeLine{\textcolor{comment}{// normally process new request here}}

\end{DoxyCode}
 

Definition at line 53 of file Client\+Table.\+hpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{56 \{}
\DoxyCodeLine{57     \textcolor{keyword}{auto} iter = record\_table.find(client\_id);}
\DoxyCodeLine{58     \textcolor{keywordflow}{if} (iter == record\_table.end()) \{}
\DoxyCodeLine{59         record\_table.insert(}
\DoxyCodeLine{60             \{client\_id, \{remote, request\_number, std::nullopt\}\});}
\DoxyCodeLine{61         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{62     \}}
\DoxyCodeLine{63 }
\DoxyCodeLine{64     \textcolor{keywordflow}{if} (!iter-\/>second.remote) \{}
\DoxyCodeLine{65         iter-\/>second.remote = remote;}
\DoxyCodeLine{66     \}}
\DoxyCodeLine{67 }
\DoxyCodeLine{68     \textcolor{keyword}{auto} \&record = iter-\/>second;}
\DoxyCodeLine{69     \textcolor{keywordflow}{if} (request\_number < record.request\_number) \{}
\DoxyCodeLine{70         \textcolor{keywordflow}{return} [](\textcolor{keyword}{auto}) \{\};}
\DoxyCodeLine{71     \}}
\DoxyCodeLine{72     \textcolor{keywordflow}{if} (request\_number == record.request\_number) \{}
\DoxyCodeLine{73         \textcolor{keywordflow}{if} (!record.reply\_message) \{}
\DoxyCodeLine{74             \textcolor{keywordflow}{return} [](\textcolor{keyword}{auto}) \{\};}
\DoxyCodeLine{75         \}}
\DoxyCodeLine{76         \textcolor{keywordflow}{return} [remote, reply = *record.reply\_message](\textcolor{keyword}{auto} on\_reply) \{}
\DoxyCodeLine{77             on\_reply(remote, reply);}
\DoxyCodeLine{78         \};}
\DoxyCodeLine{79     \}}
\DoxyCodeLine{80 }
\DoxyCodeLine{81     \textcolor{keywordflow}{if} (request\_number != record.request\_number + 1) \{}
\DoxyCodeLine{82         panic(}
\DoxyCodeLine{83             \textcolor{stringliteral}{"{}Not continuous request number: client id = \{\}, \{\} -\/> \{\}"{}},}
\DoxyCodeLine{84             client\_id, record.request\_number, request\_number);}
\DoxyCodeLine{85     \}}
\DoxyCodeLine{86 }
\DoxyCodeLine{87     record.request\_number = request\_number;}
\DoxyCodeLine{88     record.reply\_message = std::nullopt;}
\DoxyCodeLine{89     \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{90 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classoskr_1_1ClientTable_a11e9f734d654734e63b88a967ff2476a}\label{classoskr_1_1ClientTable_a11e9f734d654734e63b88a967ff2476a}} 
\index{ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}!update@{update}}
\index{update@{update}!ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}}
\doxysubsubsection{\texorpdfstring{update()}{update()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void update (\begin{DoxyParamCaption}\item[{Client\+Id}]{client\+\_\+id,  }\item[{Request\+Number}]{request\+\_\+number }\end{DoxyParamCaption})}

On handling relayed request message. Caller assumes {\ttfamily request\+\_\+number} corresponding to an currently outstanding request. 

Definition at line 93 of file Client\+Table.\+hpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{95 \{}
\DoxyCodeLine{96     \textcolor{keyword}{auto} iter = record\_table.find(client\_id);}
\DoxyCodeLine{97     \textcolor{keywordflow}{if} (iter == record\_table.end()) \{}
\DoxyCodeLine{98         record\_table.insert(}
\DoxyCodeLine{99             \{client\_id, \{std::nullopt, request\_number, std::nullopt\}\});}
\DoxyCodeLine{100         \textcolor{keywordflow}{return};}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103     \textcolor{keywordflow}{if} (iter-\/>second.request\_number >= request\_number) \{}
\DoxyCodeLine{104         warn(}
\DoxyCodeLine{105             \textcolor{stringliteral}{"{}Ignore late update (request): client id = \{:x\}, request "{}}}
\DoxyCodeLine{106             \textcolor{stringliteral}{"{}number = \{\}, recorded request = \{\}"{}},}
\DoxyCodeLine{107             client\_id, request\_number, iter-\/>second.request\_number);}
\DoxyCodeLine{108         \textcolor{keywordflow}{return};}
\DoxyCodeLine{109     \}}
\DoxyCodeLine{110 }
\DoxyCodeLine{111     iter-\/>second.request\_number = request\_number;}
\DoxyCodeLine{112     iter-\/>second.reply\_message.reset();}
\DoxyCodeLine{113 \}}

\end{DoxyCode}
\mbox{\Hypertarget{classoskr_1_1ClientTable_afe1870397cb26938df93b0244f627954}\label{classoskr_1_1ClientTable_afe1870397cb26938df93b0244f627954}} 
\index{ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}!update@{update}}
\index{update@{update}!ClientTable$<$ Transport, ReplyMessage $>$@{ClientTable$<$ Transport, ReplyMessage $>$}}
\doxysubsubsection{\texorpdfstring{update()}{update()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily auto update (\begin{DoxyParamCaption}\item[{Client\+Id}]{client\+\_\+id,  }\item[{Request\+Number}]{request\+\_\+number,  }\item[{\mbox{\hyperlink{structoskr_1_1ReplyMessage}{Reply\+Message}}}]{reply }\end{DoxyParamCaption})}

On committing.

Always return callable (instead of {\ttfamily nullptr}) even when nothing to do. 

Definition at line 116 of file Client\+Table.\+hpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{119 \{}
\DoxyCodeLine{120     \textcolor{keyword}{auto} iter = record\_table.find(client\_id);}
\DoxyCodeLine{121     \textcolor{keywordflow}{if} (iter == record\_table.end()) \{}
\DoxyCodeLine{122         warn(\textcolor{stringliteral}{"{}No record: client id = \{:x\}"{}}, client\_id);}
\DoxyCodeLine{123         record\_table.insert(\{client\_id, \{std::nullopt, request\_number, reply\}\});}
\DoxyCodeLine{124         \textcolor{keywordflow}{return} [](\textcolor{keyword}{auto}) \{\};}
\DoxyCodeLine{125     \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127     \textcolor{keywordflow}{if} (iter-\/>second.request\_number > request\_number) \{}
\DoxyCodeLine{128         warn(}
\DoxyCodeLine{129             \textcolor{stringliteral}{"{}Ignore late update: client id = \{:x\}, request number = \{\}, "{}}}
\DoxyCodeLine{130             \textcolor{stringliteral}{"{}recorded request = \{\}"{}},}
\DoxyCodeLine{131             client\_id, request\_number, iter-\/>second.request\_number);}
\DoxyCodeLine{132         \textcolor{keywordflow}{return} [](\textcolor{keyword}{auto}) \{\};}
\DoxyCodeLine{133     \}}
\DoxyCodeLine{134     \textcolor{keywordflow}{if} (iter-\/>second.request\_number < request\_number) \{}
\DoxyCodeLine{135         warn(}
\DoxyCodeLine{136             \textcolor{stringliteral}{"{}Outdated local record: client id = \{:x\}, request number = \{\}, "{}}}
\DoxyCodeLine{137             \textcolor{stringliteral}{"{}recorded request = \{\}"{}},}
\DoxyCodeLine{138             client\_id, request\_number, iter-\/>second.request\_number);}
\DoxyCodeLine{139         iter-\/>second.request\_number = request\_number;}
\DoxyCodeLine{140     \}}
\DoxyCodeLine{141 }
\DoxyCodeLine{142     iter-\/>second.reply\_message = reply;}
\DoxyCodeLine{143     \textcolor{keywordflow}{if} (!iter-\/>second.remote) \{}
\DoxyCodeLine{144         debug(\textcolor{stringliteral}{"{}Client address not recorded: id = \{:x\}"{}}, client\_id);}
\DoxyCodeLine{145         \textcolor{keywordflow}{return} [](\textcolor{keyword}{auto}) \{\};}
\DoxyCodeLine{146     \}}
\DoxyCodeLine{147 }
\DoxyCodeLine{148     \textcolor{keywordflow}{return} [remote = *iter-\/>second.remote, reply](\textcolor{keyword}{auto} on\_reply) \{}
\DoxyCodeLine{149         on\_reply(remote, reply);}
\DoxyCodeLine{150     \};}
\DoxyCodeLine{151 \}}

\end{DoxyCode}


The documentation for this class was generated from the following file\+:\begin{DoxyCompactItemize}
\item 
common/Client\+Table.\+hpp\end{DoxyCompactItemize}
